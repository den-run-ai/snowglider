<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Skiing Snowman</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #87CEEB; }
    canvas { display: block; }
    #info {
      position: absolute;
      top: 10px;
      width: calc(100% - 250px); /* Reduced width to avoid overlap with auth container */
      text-align: center;
      color: white;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      left: 125px; /* Center the element with the reduced width */
    }
    #resetBtn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 16px;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.5);
      touch-action: manipulation; /* Removes delay on mobile devices */
      user-select: none;
    }
    /* Auth UI styles */
    #authContainer {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 999; /* Higher z-index to ensure it's above other elements */
      max-width: 220px; /* Limit width to prevent overflow */
    }
    #authUI {
      display: flex;
      align-items: center;
    }
    #loginBtn {
      background-color: #4285F4;
      color: white;
      border: none;
      /* Increased padding for larger touch target */
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500; /* Slightly bolder text */
      display: flex;
      align-items: center;
      justify-content: center; /* Center text */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
      /* Prevent text selection */
      user-select: none;
      -webkit-user-select: none;
      /* Add transition for smoother visual feedback */
      transition: transform 0.1s ease, background-color 0.2s ease;
      min-height: 36px; /* Ensure consistent height */
      min-width: 120px; /* Ensure sufficient width for touch */
      position: relative; /* For ::after pseudo-element */
      overflow: visible; /* Allow overflow for glow effect */
    }
    #loginBtn:hover {
      background-color: #3367D6;
    }
    #loginBtn:active, #loginBtn.signing-in {
      background-color: #2A56C6; /* Feedback for touch action */
      transform: scale(0.98); /* Visual feedback */
    }
    /* Add ripple effect on touch */
    #loginBtn::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #loginBtn:active::after, #loginBtn.signing-in::after {
      opacity: 1;
      transition: opacity 0s;
    }
    /* Style for retry button */
    #loginBtn.retry-auth {
      background-color: #e91e63;
      animation: pulse-attention 2s infinite;
    }
    @keyframes pulse-attention {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #profileUI {
      display: none;
      align-items: center;
      color: white;
    }
    #profileAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    #profileName {
      font-size: 14px;
      margin-right: 8px;
      max-width: 90px; /* Prevent long names from causing overflow */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #logoutBtn {
      background-color: transparent;
      color: white;
      border: 1px solid white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
    }
    #logoutBtn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    #logoutBtn:active {
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0.98); /* Visual feedback */
    }
    /* Leaderboard styles */
    #leaderboard {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      color: white;
      text-align: center;
    }
    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 5px;
      text-align: left;
    }
    #leaderboard th {
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .mini-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
  <!-- Firebase SDK - Using modern modular SDK -->
  <script>
    // Check for local file protocol first before trying to use import
    const isFileProtocol = window.location.protocol === 'file:';
    const isLocalDevelopment = isFileProtocol || 
                             window.location.hostname.includes('localhost') || 
                             window.location.hostname.includes('127.0.0.1');
    
    // Add a special notice for users on localhost
    document.addEventListener('DOMContentLoaded', () => {
      const notice = document.createElement('div');
      notice.style.position = 'fixed';
      notice.style.bottom = '10px';
      notice.style.right = '10px';
      notice.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      notice.style.color = 'white';
      notice.style.padding = '8px 12px';
      notice.style.borderRadius = '4px';
      notice.style.fontSize = '12px';
      notice.style.fontFamily = 'Arial, sans-serif';
      notice.style.zIndex = '1000';
      
      if (isFileProtocol) {
        notice.innerHTML = '🏠 Local File Mode: Firebase disabled';
      } else if (isLocalDevelopment) {
        notice.innerHTML = '🛠️ Local Dev Mode: Firestore disabled';
      }
      
      document.body.appendChild(notice);
    });
    
    // Create mock Firebase modules for file:// protocol
    if (isFileProtocol) {
      console.log("File protocol detected - using mock Firebase implementation");
      
      // Mock Firebase modules
      window.firebaseModules = {
        app: null,
        auth: null,
        firestore: null,
        analytics: null,
        getAuth: () => null,
        getFirestore: () => null,
        getAnalytics: () => null,
        logEvent: (eventName, params) => {
          console.log("Analytics not available in local file mode - would log:", eventName, params);
        }
      };
      
      console.log("Mock Firebase services initialized for local file mode");
    } else {
      // For HTTP/HTTPS, load Firebase normally via a module script
      const firebaseScript = document.createElement('script');
      firebaseScript.type = 'module';
      firebaseScript.textContent = `
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
        
        // Prevent Firebase auto-init as we'll handle it manually
        window.FIREBASE_MANUAL_INIT = true;
        
        // Prevent init.json fetch attempts
        if (!window.__FIREBASE_DEFAULTS__) {
          window.__FIREBASE_DEFAULTS__ = {};
        }
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAzzpgn54sKER3aa03F2E5vlogfenP9T8Q",
          authDomain: "sn0wglider.firebaseapp.com",
          projectId: "sn0wglider",
          storageBucket: "sn0wglider.appspot.com",
          messagingSenderId: "504681218869",
          appId: "1:504681218869:web:5abbba6825691006d6027c",
          measurementId: "G-GYQC13R6MZ"
        };
        
        // Set defaults to prevent auto-init attempts
        window.__FIREBASE_DEFAULTS__ = { 
          config: firebaseConfig,
          _authTokenSyncURL: null  // Prevent token sync attempts
        };
    
        try {
          // Initialize Firebase
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          
          // Only initialize Firestore on remote hosts
          let firestore = null;
          const isLocalDevelopment = window.location.hostname.includes('localhost') || 
                                    window.location.hostname.includes('127.0.0.1');
          
          if (!isLocalDevelopment) {
            try {
              firestore = getFirestore(app);
              console.log("Firestore initialized for remote host");
            } catch (firestoreError) {
              console.warn("Firestore initialization failed:", firestoreError.message);
            }
          } else {
            console.log("Skipping Firestore initialization in local environment");
          }
          
          // Initialize analytics
          let analytics = null;
          try {
            analytics = getAnalytics(app);
          } catch (analyticsError) {
            console.warn("Analytics initialization failed:", analyticsError.message);
          }
          
          // Expose Firebase modules to window for easy access
          window.firebaseModules = {
            app,
            auth,
            firestore,
            analytics,
            getAuth: () => auth,
            getFirestore: () => firestore,
            getAnalytics: () => analytics,
            // Add direct access to logEvent function
            logEvent: (eventName, params) => {
              if (analytics) {
                logEvent(analytics, eventName, params);
              } else {
                console.log("Analytics not available - would log:", eventName, params);
              }
            }
          };
          
          console.log("Firebase services initialized in index.html");
        } catch (error) {
          console.error("Error initializing Firebase in index.html:", error.message);
          // Create a placeholder if initialization fails
          window.firebaseModules = {
            app: null,
            auth: null,
            firestore: null,
            analytics: null,
            getAuth: () => null,
            getFirestore: () => null,
            getAnalytics: () => null,
            logEvent: () => console.log("Analytics not available")
          };
        }
      `;
      
      document.head.appendChild(firebaseScript);
    }
  </script>
</head>
<body>
  <div id="info">Skiing Snowman</div>
  <button id="resetBtn">Reset</button>
  
  <!-- Auth Container -->
  <div id="authContainer">
    <div id="authUI">
      <button id="loginBtn">
        <span>Login with Google</span>
      </button>
    </div>
    <div id="profileUI">
      <img id="profileAvatar" src="" alt="Profile">
      <span id="profileName"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
  
  <!-- Leaderboard Container (will be added to game over overlay) -->
  <div id="leaderboard" style="display:none;"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Prevent Firebase auto-init via init.json -->
  <script>
    // Prevent Firebase auto-init that attempts to fetch init.json
    window.FIREBASE_MANUAL_INIT = true;
    
    // Completely prevent init.json fetch by intercepting the network request
    if (!window.__FIREBASE_DEFAULTS__) {
      window.__FIREBASE_DEFAULTS__ = {};
    }
    
    // Override fetch to prevent Firebase from fetching init.json
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (url && typeof url === 'string' && url.includes('/__/firebase/init.json')) {
        console.log('Intercepted Firebase init.json fetch request');
        return Promise.resolve(new Response(JSON.stringify({}), {
          status: 200,
          headers: { 'Content-Type': 'application/json' }
        }));
      }
      return originalFetch.apply(this, arguments);
    };
  </script>
  <script>
    // This block ensures scripts load in the right order
    document.addEventListener('DOMContentLoaded', function() {
        // First detect if we're using file:// protocol for special handling
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Handle auth.js loading based on protocol
        let authLoaded = false;
        let authLoadPromise;
        
        // For file:// protocol, we'll use an inline auth script that skips module imports
        if (isFileProtocol) {
            console.log("File protocol detected - using inline auth implementation");
            // Create a simplified auth module directly in the page
            window.AuthModule = {
                initializeAuth: function(config) {
                    console.log("Auth initialized in local mode (simplified)");
                },
                recordScore: function(time) {
                    localStorage.setItem('snowgliderBestTime', time);
                    console.log("Score recorded locally:", time);
                },
                displayLeaderboard: function() {
                    console.log("Leaderboard not available in local mode");
                    const leaderboardElement = document.getElementById('leaderboard');
                    if (leaderboardElement) {
                        leaderboardElement.innerHTML = '<h3>Leaderboard unavailable in local mode</h3>';
                    }
                },
                getCurrentUser: function() { return null; },
                isUserSignedIn: function() { return false; },
                getUserIdToken: function() { return Promise.reject("Not available in local mode"); },
                signOut: function() { return Promise.resolve(); },
                getAuthState: function() { return { user: null, isSignedIn: false }; },
                isFirebaseAvailable: function() { 
                    return { auth: false, firestore: false, analytics: false }; 
                }
            };
            authLoaded = true;
            authLoadPromise = Promise.resolve();
            
            // Update UI to show local mode
            const authUI = document.getElementById('authUI');
            const profileUI = document.getElementById('profileUI');
            
            if (authUI) authUI.style.display = 'none';
            if (profileUI) profileUI.style.display = 'none';
            
            // Add local mode notice
            const authContainer = document.getElementById('authContainer');
            if (authContainer) {
                const localModeNotice = document.createElement('div');
                localModeNotice.style.color = 'white';
                localModeNotice.style.padding = '8px';
                localModeNotice.style.textAlign = 'center';
                localModeNotice.innerHTML = '🏠 Local Mode<br>Auth disabled';
                authContainer.appendChild(localModeNotice);
            }
        } else {
            // Regular loading for http/https protocol
            const authScript = document.createElement('script');
            authScript.src = 'auth.js';
            authScript.type = 'module';
            
            authLoadPromise = new Promise(resolve => {
                authScript.onload = function() {
                    authLoaded = true;
                    resolve();
                };
                document.body.appendChild(authScript);
            });
        }
        
        // Proceed with loading other scripts once auth is handled
        authLoadPromise.then(() => {
            const mountainsScript = document.createElement('script');
            mountainsScript.src = 'mountains.js';
            
            // Then load trees.js after mountains.js has loaded
            mountainsScript.onload = function() {
                const treesScript = document.createElement('script');
                treesScript.src = 'trees.js';
                
                // Then load utils.js after trees.js has loaded
                treesScript.onload = function() {
                    const utilsScript = document.createElement('script');
                    utilsScript.src = 'utils.js';
                    
                    // Load camera.js after utils.js
                    utilsScript.onload = function() {
                        const cameraScript = document.createElement('script');
                        cameraScript.src = 'camera.js';
                        
                        // Load snowman.js after camera.js
                        cameraScript.onload = function() {
                            const snowmanScript = document.createElement('script');
                            snowmanScript.src = 'snowman.js';
                            
                            // Load controls.js after snowman.js
                            snowmanScript.onload = function() {
                                const controlsScript = document.createElement('script');
                                controlsScript.src = 'controls.js';
                                
                                // Finally load snowglider.js after controls.js
                                controlsScript.onload = function() {
                                    const mainScript = document.createElement('script');
                                    mainScript.src = 'snowglider.js';
                                
                                    // Finally load tests script if needed
                                    mainScript.onload = function() {
                                        // Always load all test scripts for the unified runner to work
                                        // But they will only execute if their specific URL parameter is present
                                        const loadTests = function() {
                                            // Determine which tests to load based on URL parameters
                                            let testsScripts = [];
                                            
                                            // Always load camera tests if ?test=camera is in URL
                                            if (window.location.search.includes('test=camera')) {
                                                console.log("Loading only camera tests");
                                                testsScripts = [
                                                    { src: 'tests/camera-tests.js', loaded: false }
                                                ];
                                            } 
                                            // Load specific controls tests if ?test=controls is in URL
                                            else if (window.location.search.includes('test=controls')) {
                                                console.log("Loading only controls tests");
                                                testsScripts = [
                                                    { src: 'tests/controls-tests.js', loaded: false }
                                                ];
                                            }
                                            // Load all tests for unified tests or when other test parameters are present
                                            else if (window.location.search.includes('test=')) {
                                                console.log("Loading all test scripts");
                                                testsScripts = [
                                                    { src: 'tests/browser-tests.js', loaded: false },
                                                    { src: 'tests/browser-regression-tests.js', loaded: false },
                                                    { src: 'tests/browser-tree-tests.js', loaded: false },
                                                    { src: 'tests/camera-tests.js', loaded: false },
                                                    { src: 'tests/controls-tests.js', loaded: false }
                                                ];
                                            }
                                            
                                            // If no test scripts to load, skip the rest
                                            if (testsScripts.length === 0) {
                                                console.log("No test scripts to load");
                                                return;
                                            }
                                            
                                            let totalLoaded = 0;
                                            
                                            // Function to check if all scripts are loaded
                                            const checkAllLoaded = function() {
                                                totalLoaded++;
                                                if (totalLoaded === testsScripts.length) {
                                                    // All individual test scripts are loaded
                                                    // Now load the unified test runner if needed
                                                    if (window.location.search.includes('test=unified')) {
                                                        console.log("Loading unified test runner...");
                                                        const unifiedRunner = document.createElement('script');
                                                        unifiedRunner.src = 'tests/unified-test-runner.js';
                                                        unifiedRunner.onload = function() {
                                                            console.log("Unified test runner loaded successfully");
                                                        };
                                                        document.body.appendChild(unifiedRunner);
                                                    } else {
                                                        console.log("Skipping unified test runner (use test=unified in URL to load it)");
                                                    }
                                                }
                                            };
                                            
                                            // Load all test scripts
                                            testsScripts.forEach(function(script) {
                                                const scriptElement = document.createElement('script');
                                                scriptElement.src = script.src;
                                                scriptElement.onload = checkAllLoaded;
                                                document.body.appendChild(scriptElement);
                                            });
                                        };
                                        
                                        // Start loading the tests
                                        loadTests();
                                        
                                        // Firebase configuration
                                        const firebaseConfig = {
                                            apiKey: "AIzaSyAzzpgn54sKER3aa03F2E5vlogfenP9T8Q",
                                            authDomain: "sn0wglider.firebaseapp.com",
                                            projectId: "sn0wglider",
                                            storageBucket: "sn0wglider.appspot.com",
                                            messagingSenderId: "504681218869",
                                            appId: "1:504681218869:web:5abbba6825691006d6027c",
                                            measurementId: "G-GYQC13R6MZ"
                                        };
                                        
                                        // Ensure __FIREBASE_DEFAULTS__ is set to prevent auto-init attempts
                                        if (!window.__FIREBASE_DEFAULTS__) {
                                            window.__FIREBASE_DEFAULTS__ = { 
                                                config: firebaseConfig,
                                                _authTokenSyncURL: null  // Prevent token sync attempts
                                            };
                                        }
                                        
                                        // For local development (file:// protocol), show a warning about Firebase limitations
                                        if (window.location.protocol === 'file:') {
                                          console.warn('⚠️ Running Firebase on local file:// protocol has limitations. Some features may not work correctly.');
                                          console.warn('For full functionality, use a local web server instead (like http-server, Python\'s SimpleHTTPServer, etc).');
                                        }
                                        
                                        // Ensure Firebase is properly initialized before proceeding
                                        setTimeout(() => {
                                            try {
                                                // Check if Firebase app is already initialized
                                                if (window.firebaseModules && window.firebaseModules.app) {
                                                    console.log("Using existing Firebase app instance from module script");
                                                    
                                                    // Initialize Auth module with existing Firebase instance
                                                    if (window.AuthModule && typeof window.AuthModule.initializeAuth === 'function') {
                                                        console.log("Initializing AuthModule with existing Firebase config");
                                                        window.AuthModule.initializeAuth(firebaseConfig);
                                                        
                                                        // Log Firebase services status
                                                        if (window.AuthModule.isFirebaseAvailable) {
                                                            const status = window.AuthModule.isFirebaseAvailable();
                                                            console.log("Firebase services status:", 
                                                                "Auth:", status.auth ? "Available" : "Unavailable",
                                                                "Firestore:", status.firestore ? "Available" : "Unavailable",
                                                                "Analytics:", status.analytics ? "Available" : "Unavailable"
                                                            );
                                                        }
                                                        
                                                        // Check if this page load might be after a mobile redirect authentication
                                                        const redirectPending = localStorage.getItem('snowglider_auth_redirect_pending');
                                                        if (redirectPending === 'true') {
                                                            console.log("Detected pending redirect authentication, checking auth state...");
                                                            // Force an immediate auth check for mobile redirects
                                                            setTimeout(() => {
                                                                if (window.AuthModule.isUserSignedIn()) {
                                                                    console.log("User is signed in after redirect");
                                                                    localStorage.removeItem('snowglider_auth_redirect_pending');
                                                                } else {
                                                                    console.log("User is still not signed in after redirect");
                                                                    // Keep pending flag for now, will be cleared after timeout
                                                                }
                                                            }, 1000);
                                                        }
                                                    } else {
                                                        console.error("AuthModule not found or initializeAuth is not a function. Check auth.js implementation.");
                                                    }
                                                } else {
                                                    console.warn("Firebase not initialized in head section, authentication features may not work correctly");
                                                }
                                            } catch (e) {
                                                console.error("Firebase initialization error in main script:", e.message);
                                            }
                                        }, 500); // Short delay to ensure auth.js is fully loaded
                                    };
                                    
                                    document.body.appendChild(mainScript);
                                };
                                
                                document.body.appendChild(controlsScript);
                            };
                            
                            document.body.appendChild(snowmanScript);
                        };
                        
                        document.body.appendChild(cameraScript);
                    };
                    
                    document.body.appendChild(utilsScript);
                };
                
                document.body.appendChild(treesScript);
            };
            
            document.body.appendChild(mountainsScript);
        });
    });
  </script>
</body>
</html>