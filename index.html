<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Skiing Snowman</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #87CEEB; }
    canvas { display: block; }
    #info {
      position: absolute;
      top: 10px;
      width: calc(100% - 250px); /* Reduced width to avoid overlap with auth container */
      text-align: center;
      color: white;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      left: 125px; /* Center the element with the reduced width */
    }
    #resetBtn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 16px;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.5);
      touch-action: manipulation; /* Removes delay on mobile devices */
      user-select: none;
    }
    /* Auth UI styles */
    #authContainer {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 999; /* Higher z-index to ensure it's above other elements */
      max-width: 220px; /* Limit width to prevent overflow */
    }
    #authUI {
      display: flex;
      align-items: center;
    }
    #loginBtn {
      background-color: #4285F4;
      color: white;
      border: none;
      /* Increased padding for larger touch target */
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500; /* Slightly bolder text */
      display: flex;
      align-items: center;
      justify-content: center; /* Center text */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
      /* Prevent text selection */
      user-select: none;
      -webkit-user-select: none;
      /* Add transition for smoother visual feedback */
      transition: transform 0.1s ease, background-color 0.2s ease;
      min-height: 36px; /* Ensure consistent height */
      min-width: 120px; /* Ensure sufficient width for touch */
      position: relative; /* For ::after pseudo-element */
      overflow: visible; /* Allow overflow for glow effect */
    }
    #loginBtn:hover {
      background-color: #3367D6;
    }
    #loginBtn:active, #loginBtn.signing-in {
      background-color: #2A56C6; /* Feedback for touch action */
      transform: scale(0.98); /* Visual feedback */
    }
    /* Add ripple effect on touch */
    #loginBtn::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #loginBtn:active::after, #loginBtn.signing-in::after {
      opacity: 1;
      transition: opacity 0s;
    }
    #profileUI {
      display: none;
      align-items: center;
      color: white;
    }
    #profileAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    #profileName {
      font-size: 14px;
      margin-right: 8px;
      max-width: 90px; /* Prevent long names from causing overflow */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #logoutBtn {
      background-color: transparent;
      color: white;
      border: 1px solid white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
    }
    #logoutBtn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    #logoutBtn:active {
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0.98); /* Visual feedback */
    }
    /* Leaderboard styles */
    #leaderboard {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      color: white;
      text-align: center;
    }
    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 5px;
      text-align: left;
    }
    #leaderboard th {
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .mini-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
  <!-- Firebase SDK - Using modern modular SDK -->
  <script>
    // Check for local file protocol first before trying to use import
    const isFileProtocol = window.location.protocol === 'file:';
    const isLocalDevelopment = isFileProtocol || 
                             window.location.hostname.includes('localhost') || 
                             window.location.hostname.includes('127.0.0.1');
    
    // Add a special notice for users on localhost
    document.addEventListener('DOMContentLoaded', () => {
      const notice = document.createElement('div');
      notice.style.position = 'fixed';
      notice.style.bottom = '10px';
      notice.style.right = '10px';
      notice.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      notice.style.color = 'white';
      notice.style.padding = '8px 12px';
      notice.style.borderRadius = '4px';
      notice.style.fontSize = '12px';
      notice.style.fontFamily = 'Arial, sans-serif';
      notice.style.zIndex = '1000';
      
      if (isFileProtocol) {
        notice.innerHTML = 'üè† Local File Mode: Firebase disabled';
      } else if (isLocalDevelopment) {
        notice.innerHTML = 'üõ†Ô∏è Local Dev Mode: Firestore disabled';
      }
      
      document.body.appendChild(notice);
    });
    
    // Create mock Firebase modules for file:// protocol
    if (isFileProtocol) {
      console.log("File protocol detected - using mock Firebase implementation");
      
      // Mock Firebase modules (AuthModule will handle this internally now)
      // window.firebaseModules = { ... }; // REMOVED
      
      console.log("Mock Firebase services will be handled by AuthModule in local file mode");
    } else {
      // --- Start Edit 1: Remove Firebase Init Module Script from Head ---
      // For HTTP/HTTPS, Firebase will be initialized within auth.js
      // const firebaseScript = document.createElement('script');
      // firebaseScript.type = 'module';
      // firebaseScript.textContent = ` ... Firebase Init Code ... `; // REMOVED
      // document.head.appendChild(firebaseScript); // REMOVED
      console.log("Firebase initialization will be handled by auth.js");
      // --- End Edit 1 ---
    }
  </script>
  <!-- --- Start Edit 2: Load auth.js module in head --- -->
  <!-- Load Auth Module - It will handle its own Firebase initialization -->
  <script src="auth.js" type="module" id="authScript"></script>
  <!-- --- End Edit 2 --- -->
</head>
<body>
  <div id="info">Skiing Snowman</div>
  <button id="resetBtn">Reset</button>
  
  <!-- Auth Container -->
  <div id="authContainer">
    <div id="authUI">
      <button id="loginBtn">
        <span>Login with Google</span>
      </button>
    </div>
    <div id="profileUI">
      <img id="profileAvatar" src="" alt="Profile">
      <span id="profileName"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
  
  <!-- Leaderboard Container (will be added to game over overlay) -->
  <div id="leaderboard" style="display:none;"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Prevent Firebase auto-init via init.json -->
  <script>
    // Prevent Firebase auto-init that attempts to fetch init.json
    window.FIREBASE_MANUAL_INIT = true;
    
    // Completely prevent init.json fetch by intercepting the network request
    if (!window.__FIREBASE_DEFAULTS__) {
      window.__FIREBASE_DEFAULTS__ = {};
    }
    
    // Override fetch to prevent Firebase from fetching init.json
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (url && typeof url === 'string' && url.includes('/__/firebase/init.json')) {
        console.log('Intercepted Firebase init.json fetch request');
        return Promise.resolve(new Response(JSON.stringify({}), {
          status: 200,
          headers: { 'Content-Type': 'application/json' }
        }));
      }
      return originalFetch.apply(this, arguments);
    };
  </script>
  <script>
    // This block ensures scripts load in the right order
    document.addEventListener('DOMContentLoaded', function() {
        // First detect if we're using file:// protocol for special handling
        const isFileProtocol = window.location.protocol === 'file:';
        
        let authLoadPromise;
        
        // For file:// protocol, use the inline auth script
        if (isFileProtocol) {
            console.log("File protocol detected - using inline auth implementation");
            // Create a simplified auth module directly in the page
            window.AuthModule = {
                initializeAuth: function(config) {
                    console.log("Auth initialized in local mode (simplified)");
                    // Update UI immediately for local mode
                    const authUI = document.getElementById('authUI');
                    const profileUI = document.getElementById('profileUI');
                    if (authUI) authUI.style.display = 'none';
                    if (profileUI) profileUI.style.display = 'none';
                    const authContainer = document.getElementById('authContainer');
                    if (authContainer && !authContainer.querySelector('.local-mode-notice')) {
                        const localModeNotice = document.createElement('div');
                        localModeNotice.className = 'local-mode-notice'; // Add class to prevent duplicates
                        localModeNotice.style.color = 'white';
                        localModeNotice.style.padding = '8px';
                        localModeNotice.style.textAlign = 'center';
                        localModeNotice.innerHTML = 'üè† Local Mode<br>Auth disabled';
                        authContainer.appendChild(localModeNotice);
                    }
                },
                recordScore: function(time) {
                    localStorage.setItem('snowgliderBestTime', time);
                    console.log("Score recorded locally:", time);
                },
                displayLeaderboard: function() {
                    console.log("Leaderboard not available in local mode");
                    const leaderboardElement = document.getElementById('leaderboard');
                    if (leaderboardElement) {
                        leaderboardElement.innerHTML = '<h3>Leaderboard unavailable in local mode</h3>';
                    }
                },
                getCurrentUser: function() { return null; },
                isUserSignedIn: function() { return false; },
                getUserIdToken: function() { return Promise.reject("Not available in local mode"); },
                signOut: function() { return Promise.resolve(); },
                getAuthState: function() { return { user: null, isSignedIn: false }; },
                isFirebaseAvailable: function() { 
                    return { auth: false, firestore: false, analytics: false }; 
                }
            };
            authLoadPromise = Promise.resolve(); // Auth is ready immediately
        } else {
            // Regular loading for http/https protocol
            // We loaded auth.js in the head, now wait for AuthModule to be defined
            authLoadPromise = new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 25; // Check for 5 seconds max (25 * 200ms)
                const checkInterval = setInterval(() => {
                    if (window.AuthModule && typeof window.AuthModule.initializeAuth === 'function') {
                        clearInterval(checkInterval);
                        console.log("AuthModule successfully detected");
                        resolve();
                    } else {
                        checkCount++;
                        if (checkCount >= maxChecks) {
                            clearInterval(checkInterval);
                            console.error("AuthModule failed to load after timeout.");
                            reject(new Error("AuthModule failed to load"));
                        }
                    }
                }, 200);
            });
        }
        
        // Proceed with loading other scripts AND initializing AuthModule
        authLoadPromise.then(() => {
            console.log("AuthModule ready, proceeding with game scripts and Auth initialization.");

            // Define Firebase config here, once
            const firebaseConfig = {
                apiKey: "AIzaSyAzzpgn54sKER3aa03F2E5vlogfenP9T8Q",
                authDomain: "sn0wglider.firebaseapp.com",
                projectId: "sn0wglider",
                storageBucket: "sn0wglider.appspot.com",
                messagingSenderId: "504681218869",
                appId: "1:504681218869:web:5abbba6825691006d6027c",
                measurementId: "G-GYQC13R6MZ"
            };

            // Initialize AuthModule - NO options needed anymore
            try {
                if (window.AuthModule && typeof window.AuthModule.initializeAuth === 'function') {
                    console.log("Calling AuthModule.initializeAuth...");

                    // Call initializeAuth WITHOUT the options object
                    window.AuthModule.initializeAuth(firebaseConfig);

                    // Log Firebase services status after initialization
                    if (window.AuthModule.isFirebaseAvailable) {
                        const status = window.AuthModule.isFirebaseAvailable();
                        console.log("Firebase services status (reported by AuthModule):", 
                            "Auth:", status.auth ? "Available" : "Unavailable",
                            "Firestore:", status.firestore ? "Available" : "Unavailable",
                            "Analytics:", status.analytics ? "Available" : "Unavailable"
                        );
                    }
                    console.log("AuthModule initialization called.");
                } else {
                   console.error("AuthModule or initializeAuth function not found when expected!");
                }
            } catch (e) {
                console.error("Error calling AuthModule.initializeAuth:", e.message, e.stack);
            }

            // Load game scripts sequentially (existing logic)
            const mountainsScript = document.createElement('script');
            mountainsScript.src = 'mountains.js';
            
            mountainsScript.onload = function() {
                const treesScript = document.createElement('script');
                treesScript.src = 'trees.js';
                
                treesScript.onload = function() {
                    const snowScript = document.createElement('script');
                    snowScript.src = 'snow.js';
                    
                    snowScript.onload = function() {
                        const cameraScript = document.createElement('script');
                        cameraScript.src = 'camera.js';
                        
                        cameraScript.onload = function() {
                            const snowmanScript = document.createElement('script');
                            snowmanScript.src = 'snowman.js';
                            
                            snowmanScript.onload = function() {
                                const controlsScript = document.createElement('script');
                                controlsScript.src = 'controls.js';
                                
                                controlsScript.onload = function() {
                                    const mainScript = document.createElement('script');
                                    mainScript.src = 'snowglider.js';
                                
                                    mainScript.onload = function() {
                                        // Load tests if needed
                                        const loadTests = function() {
                                            const urlParams = new URLSearchParams(window.location.search);
                                            const testParam = urlParams.get('test');
                                            
                                            if (testParam) {
                                                console.log(`Loading test scripts for test parameter: ${testParam}`);
                                                
                                                // Test utilities first
                                                const testUtils = document.createElement('script');
                                                testUtils.src = 'tests/unified-test-runner.js';
                                                document.body.appendChild(testUtils);
                                                
                                                // Load specific test scripts based on parameter
                                                const loadSpecificTest = (scriptName) => {
                                                    const testScript = document.createElement('script');
                                                    testScript.src = `tests/${scriptName}.js`;
                                                    document.body.appendChild(testScript);
                                                };
                                                
                                                if (testParam === 'true' || testParam === 'all' || testParam === 'unified') {
                                                    loadSpecificTest('browser-tests');
                                                }
                                                
                                                if (testParam === 'camera' || testParam === 'all' || testParam === 'unified') {
                                                    loadSpecificTest('camera-tests');
                                                }
                                                
                                                if (testParam === 'trees' || testParam === 'all' || testParam === 'unified') {
                                                    loadSpecificTest('browser-tree-tests');
                                                }
                                                
                                                if (testParam === 'regression' || testParam === 'all' || testParam === 'unified') {
                                                    loadSpecificTest('browser-regression-tests');
                                                }
                                                
                                                if (testParam === 'controls' || testParam === 'all' || testParam === 'unified') {
                                                    loadSpecificTest('controls-tests');
                                                }
                                            }
                                        };
                                        loadTests();
                                        
                                        // Config and init logic moved above/into AuthModule
                                        console.log("Main game script loaded.");
                                    };
                                    document.body.appendChild(mainScript);
                                };
                                document.body.appendChild(controlsScript);
                            };
                            document.body.appendChild(snowmanScript);
                        };
                        document.body.appendChild(cameraScript);
                    };
                    document.body.appendChild(snowScript);
                };
                document.body.appendChild(treesScript);
            };
            document.body.appendChild(mountainsScript);
        }).catch(error => {
            console.error("Failed to load or initialize AuthModule:", error);
            // Handle failure - maybe display an error message to the user
        });
    });
  </script>
</body>
</html>