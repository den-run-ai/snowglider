<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Skiing Snowman</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #87CEEB; }
    canvas { display: block; }
    #info {
      position: fixed;
      top: 10px; /* Position at top instead of 180px */
      width: auto; /* Auto width for content */
      min-width: 200px; /* Minimum width */
      max-width: 90%; /* Max width relative to viewport */
      text-align: center;
      color: white;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      left: 50%; /* Center horizontally */
      transform: translateX(-50%); /* Center perfectly */
      background-color: rgba(0, 0, 0, 0.5); /* Darker background for better visibility */
      padding: 8px 12px;
      border-radius: 5px;
      z-index: 100; /* Ensure it appears above other elements */
      white-space: nowrap; /* Keep content on one line if possible */
      overflow: hidden;
      text-overflow: ellipsis; /* Add ellipsis if content overflows */
    }
    
    /* Controls Info Panel Styles */
    #controlsContainer {
      position: fixed; /* Change to fixed for consistent positioning */
      top: 10px;
      left: 10px;
      width: 270px; /* Set specific width for stability */
      max-width: 80vw; /* Max width relative to viewport */
      z-index: 200; /* Higher than info to be on top */
      font-family: Arial, sans-serif;
      transition: all 0.3s ease;
    }
    
    #controlsInfo {
      display: flex;
      flex-direction: column;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: white;
      transition: all 0.3s ease;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); /* Add shadow for better visibility */
      width: auto;
    }
    
    #controlsContent {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px; /* Height when expanded */
      overflow-y: auto; /* Allow scrolling */
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    #controlsInfo.collapsed {
      width: auto;
      max-width: 180px;
    }
    
    #controlsInfo.collapsed #controlsContent {
      max-height: 0;
      margin-top: 0;
      margin-bottom: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }
    
    #controlsHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      user-select: none; /* Prevent text selection */
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    
    /* Add swipe indicator for mobile */
    #controlsHeader::after {
      content: "⟷";
      position: absolute;
      right: 30px;
      font-size: 14px;
      opacity: 0.6;
      color: #ffff99;
    }
    
    /* Show swipe indicator only on touch devices */
    @media (hover: none) and (pointer: coarse) {
      #controlsHeader::after {
        display: block;
      }
    }
    
    @media (hover: hover) and (pointer: fine) {
      #controlsHeader::after {
        display: none;
      }
    }
    
    /* When collapsed, remove bottom border */
    #controlsInfo.collapsed #controlsHeader {
      border-bottom-color: transparent;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    
    #controlsHeader h3 {
      margin: 0;
      font-size: 16px;
      color: #ffffff;
    }
    
    .control-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
      line-height: 1.5;
    }
    
    .key-badge {
      background-color: #4a69bd;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 8px;
      font-family: monospace;
      font-size: 13px;
      min-width: 45px;
      text-align: center;
    }
    
    #toggleControls {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      color: white;
    }
    
    /* Game Stats Window - Combined stats and timer */
    #gameStatsContainer {
      position: fixed;
      top: 70px; /* Positioned below authContainer */
      right: 10px; /* Aligned with authContainer */
      left: auto; /* Remove left positioning */
      transform: none; /* Remove horizontal centering */
      padding: 8px 12px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      font-family: Arial, sans-serif;
      font-size: 16px;
      border-radius: 5px;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      overflow: hidden;
      max-width: 90%;
      width: auto;
    }
    
    #gameStatsHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 4px;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    /* Add horizontal swipe indicator */
    #gameStatsHeader::after {
      content: "⟷";
      position: absolute;
      right: 30px;
      font-size: 14px;
      opacity: 0.6;
      color: #ffff99;
    }
    
    /* Show swipe indicator only on touch devices */
    @media (hover: none) and (pointer: coarse) {
      #gameStatsHeader::after {
        display: block;
      }
    }
    
    @media (hover: hover) and (pointer: fine) {
      #gameStatsHeader::after {
        display: none;
      }
    }
    
    #gameStatsHeader h3 {
      margin: 0;
      font-size: 16px;
      color: #ffffff;
    }
    
    #toggleStats {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      color: white;
    }
    
    #gameStatsContent {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      transition: all 0.3s ease;
      max-height: 100px;
      overflow: hidden;
    }
    
    #gameStatsContainer.collapsed {
      width: auto;
      max-width: 160px;
    }
    
    #gameStatsContainer.collapsed #gameStatsContent {
      max-height: 0;
      margin-top: 0;
      margin-bottom: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }
    
    #gameStatsContainer.collapsed #gameStatsHeader {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: bold;
    }
    
    /* Auth UI styles - positioned at top right */
    #authContainer {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 999; /* Higher z-index to ensure it's above other elements */
      max-width: 220px; /* Limit width to prevent overflow */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    /* Mobile/responsive adjustments */
    @media (max-width: 768px) {
      #info {
        display: none; /* Hidden as it's replaced by gameStats */
      }
      
      #controlsInfo {
        max-width: 250px;
        font-size: 13px;
      }
      
      #gameStatsContainer {
        font-size: 14px;
        padding: 6px 10px;
        top: 60px; /* Adjusted for mobile */
      }
      
      .stat-value {
        font-size: 14px;
      }
      
      .stat-label {
        font-size: 11px;
      }
    }
    
    @media (max-width: 480px) {
      #controlsContainer {
        width: 220px; /* Smaller on mobile */
      }
      
      #controlsInfo.collapsed {
        max-width: 150px;
      }
      
      #controlsInfo.collapsed #controlsContent {
        max-height: 0;
        opacity: 0;
      }
      
      #controlsHeader h3 {
        font-size: 14px;
      }
      
      .key-badge {
        min-width: 38px;
        font-size: 12px;
      }
      
      #gameStatsContainer {
        font-size: 12px;
        padding: 5px 8px;
        top: 55px; /* Adjusted for smaller mobile screens */
        max-width: 160px; /* Keep it compact on small screens */
      }
      
      #gameStatsHeader h3 {
        font-size: 14px;
      }
      
      .stat-value {
        font-size: 13px;
      }
      
      .stat-item {
        min-width: 60px;
      }
      
      /* Move auth container to top-right corner */
      #authContainer {
        top: 10px;
        right: 10px;
        max-width: 160px; /* Smaller on mobile */
        padding: 3px;
      }
      
      /* Make login button smaller on mobile */
      #loginBtn {
        font-size: 12px;
        padding: 4px 8px;
      }
      
      /* Make the profile UI smaller on mobile */
      #profileUI {
        font-size: 12px;
      }
      
      #profileAvatar {
        width: 24px;
        height: 24px;
      }
    }
    
    /* Fix for very small screens in landscape */
    @media (max-height: 400px) and (orientation: landscape) {
      #info {
        top: 40px; /* Make sure it's visible on very small screens */
      }
      
      #gameStatsContainer {
        padding: 4px 8px;
        max-width: 80%;
      }
      
      #controlsInfo.collapsed {
        max-width: 140px;
      }
      
      #controlsInfo.collapsed #controlsContent {
        max-height: 0;
        opacity: 0;
      }
    }
    
    /* Landscape mode specific adjustments */
    @media (orientation: landscape) and (max-height: 500px) {
      #info {
        top: 50px; /* Lower position in landscape */
      }
      
      #controlsContainer {
        width: 240px;
      }
      
      #controlsInfo.collapsed {
        max-width: 160px;
      }
      
      #controlsInfo.collapsed #controlsContent {
        max-height: 0;
        opacity: 0;
      }
      
      #controlsInfo {
        max-height: 180px; /* Limit height in landscape to prevent overflow */
      }
      
      #gameStatsContainer {
        font-size: 14px;
        padding: 5px 8px;
        max-width: 85%;
      }
    }
    
    /* Portrait mode specific adjustments */
    @media (orientation: portrait) {
      #info {
        top: 55px; /* Position below controls */
        max-width: 70%;
      }
      
      #controlsInfo {
        max-width: 280px; /* Wider on portrait */
      }
    }
    
    #resetBtn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 16px;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.5);
      touch-action: manipulation; /* Removes delay on mobile devices */
      user-select: none;
    }
    #audioControlBtn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.5);
      touch-action: manipulation;
      user-select: none;
      z-index: 1001;
    }
    #audioSelect {
      position: absolute;
      bottom: 70px;
      right: 20px;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      z-index: 1001;
      display: none; /* Initially hidden */
    }
    #authUI {
      display: flex;
      align-items: center;
    }
    #loginBtn {
      background-color: #4285F4;
      color: white;
      border: none;
      /* Increased padding for larger touch target */
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500; /* Slightly bolder text */
      display: flex;
      align-items: center;
      justify-content: center; /* Center text */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
      /* Prevent text selection */
      user-select: none;
      -webkit-user-select: none;
      /* Add transition for smoother visual feedback */
      transition: transform 0.1s ease, background-color 0.2s ease;
      min-height: 36px; /* Ensure consistent height */
      min-width: 120px; /* Ensure sufficient width for touch */
      position: relative; /* For ::after pseudo-element */
      overflow: visible; /* Allow overflow for glow effect */
    }
    #loginBtn:hover {
      background-color: #3367D6;
    }
    #loginBtn:active, #loginBtn.signing-in {
      background-color: #2A56C6; /* Feedback for touch action */
      transform: scale(0.98); /* Visual feedback */
    }
    /* Add ripple effect on touch */
    #loginBtn::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #loginBtn:active::after, #loginBtn.signing-in::after {
      opacity: 1;
      transition: opacity 0s;
    }
    #profileUI {
      display: none;
      align-items: center;
      color: white;
    }
    #profileAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    #profileName {
      font-size: 14px;
      margin-right: 8px;
      max-width: 90px; /* Prevent long names from causing overflow */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #logoutBtn {
      background-color: transparent;
      color: white;
      border: 1px solid white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; /* Better touch response */
    }
    #logoutBtn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    #logoutBtn:active {
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0.98); /* Visual feedback */
    }
    /* Leaderboard styles */
    #leaderboard {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      color: white;
      text-align: center;
    }
    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboard th, #leaderboard td {
      padding: 5px;
      text-align: left;
    }
    #leaderboard th {
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .mini-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }
    
    /* Highlight current user's score in leaderboard */
    .current-user-score {
      font-weight: bold;
      background-color: rgba(76, 175, 80, 0.2);
    }
    /* Enhanced Start Game Container styles */
    #startGameContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      color: white;
      font-family: 'Arial', sans-serif;
      padding: 10px; /* Add padding to ensure content doesn't touch the edge */
      overflow-y: auto; /* Allow scrolling if needed */
    }
    
    #gameTitle {
      font-size: 42px; /* Slightly reduced from 48px */
      color: #ffffff;
      text-shadow: 0 0 10px #87CEEB, 0 0 20px #4CAF50;
      margin-bottom: 10px; /* Reduced from 20px */
      letter-spacing: 2px;
      animation: pulse 2s infinite;
      text-align: center;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #gameDescription {
      font-size: 16px; /* Reduced from 18px */
      max-width: 600px;
      text-align: center;
      margin-bottom: 15px; /* Reduced from 30px */
      line-height: 1.4; /* Slightly reduced from 1.5 */
    }
    
    #controlsGuide {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 10px 20px; /* Reduced from 15px 25px */
      margin-bottom: 15px; /* Reduced from 30px */
      max-width: 500px;
      text-align: left;
      max-height: 180px; /* Add max height */
      overflow-y: auto; /* Make scrollable if needed */
    }
    
    #controlsGuide h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 8px; /* Reduced from 10px */
      font-size: 16px; /* Added smaller font size */
    }
    
    .control-row {
      display: flex;
      justify-content: space-between;
      margin: 6px 0; /* Reduced from 8px */
      font-size: 14px; /* Added smaller font size */
    }
    
    .key {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      padding: 1px 6px; /* Reduced from 2px 8px */
      font-family: monospace;
      font-weight: bold;
    }
    
    #startMenu {
      display: flex;
      flex-direction: column;
      gap: 10px; /* Reduced from 15px */
      align-items: center;
      margin-bottom: 10px; /* Reduced from 20px */
      width: 280px;
    }
    
    .menu-button {
      padding: 12px 20px; /* Reduced from 15px 30px */
      font-size: 16px; /* Reduced from 20px */
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      min-width: 220px; /* Reduced from 250px */
      text-align: center;
      -webkit-tap-highlight-color: transparent; /* Remove default mobile highlight */
      touch-action: manipulation; /* Improve touch response */
      position: relative; /* For touch feedback effect */
    }
    
    .menu-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 0.1s;
      border-radius: 8px;
    }
    
    .menu-button:active::after,
    .menu-button.touch-active::after {
      opacity: 1;
    }
    
    .menu-button.start {
      background-color: #4CAF50;
    }
    
    .menu-button.options {
      background-color: #4a69bd;
    }
    
    .menu-button.about {
      background-color: #ff7979;
    }
    
    .menu-button:hover {
      background-color: #45a049;
      transform: scale(1.05);
    }
    
    .menu-button.options:hover {
      background-color: #3c58b0;
    }
    
    .menu-button.about:hover {
      background-color: #ff6b6b;
    }
    
    .menu-button:active {
      transform: scale(0.98);
    }
    
    #aboutGamePanel {
      display: none;
      background-color: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      padding: 15px; /* Reduced from 20px */
      margin-top: 10px; /* Reduced from 20px */
      margin-bottom: 10px; /* Reduced from 20px */
      max-width: 600px;
      text-align: center;
      font-size: 14px; /* Added smaller font size */
    }
    
    #aboutGamePanel h3 {
      margin-top: 0;
      margin-bottom: 10px; /* Reduced from 15px */
      color: #ff7979;
      font-size: 18px; /* Added smaller font size */
    }
    
    #aboutGamePanel p {
      margin-bottom: 8px; /* Reduced from 10px */
      line-height: 1.4; /* Slightly reduced from 1.5 */
    }
    
    #keyboardHint {
      font-style: italic;
      opacity: 0.8;
      margin-top: 8px; /* Reduced from 15px */
      font-size: 14px; /* Added smaller font size */
    }
    #gameCanvas {
      display: none; /* Initially hidden until game starts */
    }
    
    @media (max-height: 650px) {
      /* Adjustments for smaller height screens */
      #gameTitle {
        font-size: 32px;
        margin-bottom: 5px;
      }
      
      #gameDescription {
        font-size: 14px;
        margin-bottom: 10px;
        max-width: 90%;
      }
      
      #controlsGuide {
        max-height: 120px;
        margin-bottom: 10px;
      }
      
      .menu-button {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      /* Adjustments for mobile screens */
      #gameTitle {
        font-size: 28px;
      }
      
      #controlsGuide {
        padding: 8px 15px;
        max-width: 90%;
      }
    }
    
    /* Increase touch target size for mobile */
    @media (max-width: 768px) {
      .menu-button {
        min-height: 44px; /* Apple's recommended minimum touch target size */
        padding: 12px 24px;
      }
    }
  </style>
  <!-- Firebase SDK - Using modern modular SDK -->
  <script>
    // Check for local file protocol first before trying to use import
    const isFileProtocol = window.location.protocol === 'file:';
    const isLocalDevelopment = isFileProtocol || 
                             window.location.hostname.includes('localhost') || 
                             window.location.hostname.includes('127.0.0.1');
    
    // Add a special notice for users on localhost
    document.addEventListener('DOMContentLoaded', () => {
      const notice = document.createElement('div');
      notice.style.position = 'fixed';
      notice.style.bottom = '10px';
      notice.style.right = '10px';
      notice.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      notice.style.color = 'white';
      notice.style.padding = '8px 12px';
      notice.style.borderRadius = '4px';
      notice.style.fontSize = '12px';
      notice.style.fontFamily = 'Arial, sans-serif';
      notice.style.zIndex = '1000';
      
      if (isFileProtocol) {
        notice.innerHTML = '🏠 Local File Mode: Firebase disabled';
      } else if (isLocalDevelopment) {
        notice.innerHTML = '🛠️ Local Dev Mode: Firestore disabled';
      }
      
      document.body.appendChild(notice);
    });
    
    if (isFileProtocol) {
      console.log("File protocol detected - using mock Firebase implementation");
      console.log("Mock Firebase services will be handled by AuthModule in local file mode");
      
      // Create inline ScoresModule for file:// protocol first
      window.ScoresModule = {
        initializeScores: function(firestoreInstance, analyticsInstance) {
          console.log("ScoresModule initialized in local mode (simplified)");
        },
        setCurrentUser: function(user) { 
          console.log("ScoresModule: setCurrentUser called in local mode"); 
        },
        recordScore: function(time) {
          // Store in localStorage
          const localBestTimeStr = localStorage.getItem('snowgliderBestTime');
          const localBestTime = localBestTimeStr ? parseFloat(localBestTimeStr) : null;
          const isNewPersonalBest = localBestTime === null || time < localBestTime;

          if (isNewPersonalBest) {
            localStorage.setItem('snowgliderBestTime', time.toString());
            console.log("New local best time recorded:", time);
          } else {
            console.log("Score recorded, but not a new local best time:", time);
          }
        },
        displayLeaderboard: function() {
          console.log("Leaderboard not available in local file mode");
          const leaderboardElement = document.getElementById('leaderboard');
          if (leaderboardElement) {
            leaderboardElement.innerHTML = '<h3>Leaderboard unavailable in local file mode</h3>';
          }
        },
        getLeaderboard: function() { return Promise.resolve([]); },
        updateUserBestTime: function(userId, time) { 
          console.log("updateUserBestTime not available in local file mode"); 
        },
        updateLeaderboard: function(userId, time) { 
          console.log("updateLeaderboard not available in local file mode"); 
        },
        isFirestoreAvailable: function() { return false; }
      };

      // Do not include the module scripts at all in file:// mode
    } else {
      console.log("Firebase initialization will be handled by auth.js");
      
      // Dynamically add the module scripts only for non-file:// protocol
      const head = document.getElementsByTagName('head')[0];
      
      // Load Scores Module
      const scoresScript = document.createElement('script');
      scoresScript.type = 'module';
      scoresScript.id = 'scoresScript';
      scoresScript.src = 'scores.js';
      head.appendChild(scoresScript);
      
      // Load Auth Module
      const authScript = document.createElement('script');
      authScript.type = 'module';
      authScript.id = 'authScript';
      authScript.src = 'auth.js';
      head.appendChild(authScript);
    }
  </script>
  <!-- Load Scripts in head - REMOVED AND REPLACED WITH DYNAMIC LOADING ABOVE -->
</head>
<body>
  <!-- Start Game Container and Button -->
  <div id="startGameContainer">
    <h1 id="gameTitle">❄️ 🎿 ⛰️ SnowGlider ☃️ ❄️</h1>
    <p id="gameDescription">Race down the mountain as a snowman, dodge trees, perform jumps and try to reach the bottom with the fastest time!</p>
    
    <div id="controlsGuide">
      <h3>Controls</h3>
      <div class="control-row">
        <span><span class="key">←</span> <span class="key">A</span></span>
        <span>Turn Left</span>
      </div>
      <div class="control-row">
        <span><span class="key">→</span> <span class="key">D</span></span>
        <span>Turn Right</span>
      </div>
      <div class="control-row">
        <span><span class="key">↑</span> <span class="key">W</span></span>
        <span>Accelerate</span>
      </div>
      <div class="control-row">
        <span><span class="key">↓</span> <span class="key">S</span></span>
        <span>Brake</span>
      </div>
      <div class="control-row">
        <span><span class="key">Space</span></span>
        <span>Jump</span>
      </div>
      <div class="control-row">
        <span><span class="key">V</span></span>
        <span>Toggle Chase View</span>
      </div>
    </div>
    
    <div id="startMenu">
      <button id="startGameButton" class="menu-button start">Start Game with Music</button>
      <button id="aboutGameButton" class="menu-button about">About Game</button>
    </div>
    
    <div id="aboutGamePanel">
      <h3>About SnowGlider</h3>
      <p>SnowGlider is a 3D skiing game where you control a snowman racing down a mountain.</p>
      <p>Your goal is to reach the bottom of the slope as fast as possible while avoiding trees and obstacles.</p>
      <p>Perform jumps off slopes, control your speed, and try to set new personal best times!</p>
      <p>Made with Three.js and a lot of love for winter sports.</p>
      <button id="closeAboutButton" class="menu-button">Close</button>
    </div>
    
    <p id="keyboardHint">Press <span class="key">Enter</span> or <span class="key">Space</span> to start the game</p>
  </div>

  <!-- Game Stats Container - Combined stats window -->
  <div id="gameStatsContainer">
    <div id="gameStatsHeader">
      <h3>📊 Game Stats</h3>
      <button id="toggleStats">▲</button>
    </div>
    <div id="gameStatsContent">
      <div class="stat-item">
        <span class="stat-label">Current Time</span>
        <span id="currentTime" class="stat-value">0.00s</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Best Time</span>
        <span id="bestTimeValue" class="stat-value">--</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Speed</span>
        <span id="speedValue" class="stat-value">0.0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Position</span>
        <span id="positionValue" class="stat-value">0,0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Status</span>
        <span id="groundStatus" class="stat-value">⛷️ Ground</span>
      </div>
    </div>
  </div>
  
  <!-- Controls Container -->
  <div id="controlsContainer">
    <div id="controlsInfo">
      <div id="controlsHeader">
        <h3>⌨️ Game Controls</h3>
        <button id="toggleControls">▲</button>
      </div>
      <div id="controlsContent">
        <div class="control-item">
          <span class="key-badge">←/A</span> 
          <span>Turn Left</span>
        </div>
        <div class="control-item">
          <span class="key-badge">→/D</span>
          <span>Turn Right</span>
        </div>
        <div class="control-item">
          <span class="key-badge">↑/W</span>
          <span>Accelerate</span>
        </div>
        <div class="control-item">
          <span class="key-badge">↓/S</span>
          <span>Brake</span>
        </div>
        <div class="control-item">
          <span class="key-badge">Space</span>
          <span>Jump</span>
        </div>
        <div class="control-item">
          <span class="key-badge">V</span>
          <span>Toggle Camera View</span>
        </div>
      </div>
    </div>
  </div>
  
  <button id="resetBtn">Reset</button>
  
  <!-- Auth Container -->
  <div id="authContainer">
    <div id="authUI">
      <button id="loginBtn">
        <span>Login with Google</span>
      </button>
    </div>
    <div id="profileUI">
      <img id="profileAvatar" src="" alt="Profile">
      <span id="profileName"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
  
  <!-- Leaderboard Container (will be added to game over overlay) -->
  <div id="leaderboard" style="display:none;"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <!-- Audio resources - removed HTML audio elements in favor of THREE.js AudioLoader -->
  <!-- We no longer use HTML audio elements as they have inconsistent behavior on mobile -->
  <!-- THREE.js AudioLoader with WebAudio API provides better cross-platform support -->
  <!-- Prevent Firebase auto-init via init.json -->
  <script>
    // Prevent Firebase auto-init that attempts to fetch init.json
    window.FIREBASE_MANUAL_INIT = true;
    
    // Completely prevent init.json fetch by intercepting the network request
    if (!window.__FIREBASE_DEFAULTS__) {
      window.__FIREBASE_DEFAULTS__ = {};
    }
    
    // Override fetch to prevent Firebase from fetching init.json
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (url && typeof url === 'string' && url.includes('/__/firebase/init.json')) {
        console.log('Intercepted Firebase init.json fetch request');
        return Promise.resolve(new Response(JSON.stringify({}), {
          status: 200,
          headers: { 'Content-Type': 'application/json' }
        }));
      }
      return originalFetch.apply(this, arguments);
    };
  </script>
  <script>
    // This block ensures scripts load in the right order
    document.addEventListener('DOMContentLoaded', function() {
        // First detect if we're using file:// protocol for special handling
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Add event listeners to initialize audio context on various user interactions
        const initAudioContext = () => {
            if (window.AudioContext || window.webkitAudioContext) {
                try {
                    // Create a temporary audio context just to unlock audio on iOS/mobile
                    const tempContext = new (window.AudioContext || window.webkitAudioContext)();
                    const tempOscillator = tempContext.createOscillator();
                    const tempGain = tempContext.createGain();
                    tempGain.gain.value = 0.001; // Nearly silent
                    tempOscillator.connect(tempGain);
                    tempGain.connect(tempContext.destination);
                    tempOscillator.start(0);
                    tempOscillator.stop(0.001);
                    
                    console.log("Audio context initialized early via user interaction");
                    
                    // Resume the context if needed (for Chrome)
                    if (tempContext.state === 'suspended') {
                        tempContext.resume().then(() => {
                            console.log("Temporary audio context resumed successfully");
                        });
                    }
                } catch (e) {
                    console.warn("Early audio context initialization failed:", e);
                }
            }
        };
        
        // Add listeners to multiple event types to ensure we catch the first interaction
        document.addEventListener('click', initAudioContext, { once: false, passive: true });
        document.addEventListener('touchstart', initAudioContext, { once: false, passive: true });
        document.addEventListener('keydown', initAudioContext, { once: false, passive: true });
        
        let authLoadPromise;
        
        // For file:// protocol, use the inline auth script
        if (isFileProtocol) {
            console.log("File protocol detected - using inline auth implementation");
            // Create a simplified auth module directly in the page
            window.AuthModule = {
                initializeAuth: function(config) {
                    console.log("Auth initialized in local mode (simplified)");
                    // Update UI immediately for local mode
                    const authUI = document.getElementById('authUI');
                    const profileUI = document.getElementById('profileUI');
                    if (authUI) authUI.style.display = 'none';
                    if (profileUI) profileUI.style.display = 'none';
                    const authContainer = document.getElementById('authContainer');
                    if (authContainer && !authContainer.querySelector('.local-mode-notice')) {
                        const localModeNotice = document.createElement('div');
                        localModeNotice.className = 'local-mode-notice'; // Add class to prevent duplicates
                        localModeNotice.style.color = 'white';
                        localModeNotice.style.padding = '8px';
                        localModeNotice.style.textAlign = 'center';
                        localModeNotice.innerHTML = '🏠 Local Mode<br>Auth disabled';
                        authContainer.appendChild(localModeNotice);
                    }
                },
                recordScore: function(time) {
                    // Forward to ScoresModule which we've already defined above
                    if (window.ScoresModule && typeof window.ScoresModule.recordScore === 'function') {
                        window.ScoresModule.recordScore(time);
                    } else {
                        localStorage.setItem('snowgliderBestTime', time);
                        console.log("Score recorded locally:", time);
                    }
                },
                displayLeaderboard: function() {
                    // Forward to ScoresModule
                    if (window.ScoresModule && typeof window.ScoresModule.displayLeaderboard === 'function') {
                        window.ScoresModule.displayLeaderboard();
                    } else {
                        console.log("Leaderboard not available in local mode");
                        const leaderboardElement = document.getElementById('leaderboard');
                        if (leaderboardElement) {
                            leaderboardElement.innerHTML = '<h3>Leaderboard unavailable in local mode</h3>';
                        }
                    }
                },
                getCurrentUser: function() { return null; },
                isUserSignedIn: function() { return false; },
                getUserIdToken: function() { return Promise.reject("Not available in local mode"); },
                signOut: function() { return Promise.resolve(); },
                getAuthState: function() { return { user: null, isSignedIn: false }; },
                isFirebaseAvailable: function() { 
                    return { auth: false, firestore: false, analytics: false }; 
                }
            };
            authLoadPromise = Promise.resolve(); // Auth is ready immediately
        } else {
            // Regular loading for http/https protocol
            // We loaded auth.js in the head, now wait for AuthModule to be defined
            authLoadPromise = new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 25; // Check for 5 seconds max (25 * 200ms)
                const checkInterval = setInterval(() => {
                    if (window.AuthModule && typeof window.AuthModule.initializeAuth === 'function') {
                        clearInterval(checkInterval);
                        console.log("AuthModule successfully detected");
                        resolve();
                    } else {
                        checkCount++;
                        if (checkCount >= maxChecks) {
                            clearInterval(checkInterval);
                            console.error("AuthModule failed to load after timeout.");
                            reject(new Error("AuthModule failed to load"));
                        }
                    }
                }, 200);
            });
        }
        
        // Proceed with loading other scripts AND initializing AuthModule
        authLoadPromise.then(() => {
            console.log("AuthModule ready, proceeding with game scripts and Auth initialization.");

            // Define Firebase config here, once
            const firebaseConfig = {
                apiKey: "AIzaSyAzzpgn54sKER3aa03F2E5vlogfenP9T8Q",
                authDomain: "sn0wglider.firebaseapp.com",
                projectId: "sn0wglider",
                storageBucket: "sn0wglider.appspot.com",
                messagingSenderId: "504681218869",
                appId: "1:504681218869:web:5abbba6825691006d6027c",
                measurementId: "G-GYQC13R6MZ"
            };

            // Initialize AuthModule - NO options needed anymore
            try {
                if (window.AuthModule && typeof window.AuthModule.initializeAuth === 'function') {
                    console.log("Calling AuthModule.initializeAuth...");

                    // Call initializeAuth WITHOUT the options object
                    window.AuthModule.initializeAuth(firebaseConfig);

                    // Log Firebase services status after initialization
                    if (window.AuthModule.isFirebaseAvailable) {
                        const status = window.AuthModule.isFirebaseAvailable();
                        console.log("Firebase services status (reported by AuthModule):", 
                            "Auth:", status.auth ? "Available" : "Unavailable",
                            "Firestore:", status.firestore ? "Available" : "Unavailable",
                            "Analytics:", status.analytics ? "Available" : "Unavailable"
                        );
                    }
                    console.log("AuthModule initialization called.");
                } else {
                   console.error("AuthModule or initializeAuth function not found when expected!");
                }
            } catch (e) {
                console.error("Error calling AuthModule.initializeAuth:", e.message, e.stack);
            }

            // Load game scripts sequentially (existing logic)
            const mountainsScript = document.createElement('script');
            mountainsScript.src = 'mountains.js';
            
            mountainsScript.onload = function() {
                const treesScript = document.createElement('script');
                treesScript.src = 'trees.js';
                
                treesScript.onload = function() {
                    const snowScript = document.createElement('script');
                    snowScript.src = 'snow.js';
                    
                    snowScript.onload = function() {
                        const cameraScript = document.createElement('script');
                        cameraScript.src = 'camera.js';
                        
                        cameraScript.onload = function() {
                            const snowmanScript = document.createElement('script');
                            snowmanScript.src = 'snowman.js';
                            
                            snowmanScript.onload = function() {
                                const audioScript = document.createElement('script');
                                audioScript.src = 'audio.js';
                                
                                audioScript.onload = function() {
                                    const controlsScript = document.createElement('script');
                                    controlsScript.src = 'controls.js';
                                    
                                    controlsScript.onload = function() {
                                        const mainScript = document.createElement('script');
                                        mainScript.src = 'snowglider.js';
                                        
                                        mainScript.onload = function() {
                                            // Load tests if needed
                                            const loadTests = function() {
                                                const urlParams = new URLSearchParams(window.location.search);
                                                const testParam = urlParams.get('test');
                                                
                                                if (testParam) {
                                                    console.log(`Loading test scripts for test parameter: ${testParam}`);
                                                    
                                                    // Test utilities first
                                                    const testUtils = document.createElement('script');
                                                    testUtils.src = 'tests/unified-test-runner.js';
                                                    document.body.appendChild(testUtils);
                                                    
                                                    // Load specific test scripts based on parameter
                                                    const loadSpecificTest = (scriptName) => {
                                                        const testScript = document.createElement('script');
                                                        testScript.src = `tests/${scriptName}.js`;
                                                        document.body.appendChild(testScript);
                                                    };
                                                    
                                                    if (testParam === 'true' || testParam === 'all' || testParam === 'unified') {
                                                        loadSpecificTest('browser-tests');
                                                    }
                                                    
                                                    if (testParam === 'camera' || testParam === 'all' || testParam === 'unified') {
                                                        loadSpecificTest('camera-tests');
                                                    }
                                                    
                                                    if (testParam === 'trees' || testParam === 'all' || testParam === 'unified') {
                                                        loadSpecificTest('browser-tree-tests');
                                                    }
                                                    
                                                    if (testParam === 'regression' || testParam === 'all' || testParam === 'unified') {
                                                        loadSpecificTest('browser-regression-tests');
                                                    }
                                                    
                                                    if (testParam === 'controls' || testParam === 'all' || testParam === 'unified') {
                                                        loadSpecificTest('controls-tests');
                                                    }
                                                }
                                            };
                                            loadTests();
                                            
                                            // Config and init logic moved above/into AuthModule
                                            console.log("Main game script loaded.");
                                            
                                            // Pre-load audio as soon as possible (but don't play yet)
                                            setTimeout(() => {
                                              if (window.AudioModule && typeof window.AudioModule.preloadAudio === 'function') {
                                                window.AudioModule.preloadAudio('drum_loop')
                                                  .then(() => {
                                                    console.log("Audio pre-loaded and ready for user interaction");
                                                  })
                                                  .catch(err => {
                                                    console.warn("Could not pre-load audio:", err);
                                                  });
                                              }
                                            }, 500);
                                        };
                                        document.body.appendChild(mainScript);
                                    };
                                    document.body.appendChild(controlsScript);
                                };
                                document.body.appendChild(audioScript);
                            };
                            document.body.appendChild(snowmanScript);
                        };
                        document.body.appendChild(cameraScript);
                    };
                    document.body.appendChild(snowScript);
                };
                document.body.appendChild(treesScript);
            };
            document.body.appendChild(mountainsScript);
        }).catch(error => {
            console.error("Failed to load or initialize AuthModule:", error);
            // Handle failure - maybe display an error message to the user
        });

        // Add start game button handler
        document.getElementById('startGameButton').addEventListener('click', async function() {
            console.log("Start button clicked - attempting audio unlock");
            
            // Try to initialize audio context again just before starting game
            initAudioContext();
            
            // Step 1: Resume AudioContext in THIS user gesture
            if (window.AudioModule) {
              try {
                await window.AudioModule.resumeAudioContext();
                console.log("AudioContext resumed in click handler");
              } catch (e) {
                console.warn("Could not resume AudioContext:", e);
              }
              
              // Step 2: Play pre-loaded audio immediately (still in user gesture context)
              window.AudioModule.playPreloadedAudio();
            }
            
            // Step 3: Start the game
            startGame();
        });
        
        // Add about game button handler
        document.getElementById('aboutGameButton').addEventListener('click', function() {
            const aboutPanel = document.getElementById('aboutGamePanel');
            const controlsGuide = document.getElementById('controlsGuide');
            const startMenu = document.getElementById('startMenu');
            const keyboardHint = document.getElementById('keyboardHint');
            
            aboutPanel.style.display = 'block';
            controlsGuide.style.display = 'none';
            startMenu.style.display = 'none';
            keyboardHint.style.display = 'none';
        });
        
        // Add close about button handler
        document.getElementById('closeAboutButton').addEventListener('click', function() {
            const aboutPanel = document.getElementById('aboutGamePanel');
            const controlsGuide = document.getElementById('controlsGuide');
            const startMenu = document.getElementById('startMenu');
            const keyboardHint = document.getElementById('keyboardHint');
            
            aboutPanel.style.display = 'none';
            controlsGuide.style.display = 'block';
            startMenu.style.display = 'flex';
            keyboardHint.style.display = 'block';
        });
        
        // Add keyboard handlers for starting the game
        document.addEventListener('keydown', function(event) {
            // Check if the start container is visible and about panel is hidden
            const startContainer = document.getElementById('startGameContainer');
            const aboutPanel = document.getElementById('aboutGamePanel');
            
            if (startContainer && 
                startContainer.style.display !== 'none' && 
                aboutPanel.style.display !== 'block') {
                
                // Start game on Enter or Space
                if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
                    startGame();
                }
            } else if (aboutPanel && aboutPanel.style.display === 'block') {
                // Close about panel on Escape
                if (event.key === 'Escape') {
                    document.getElementById('closeAboutButton').click();
                }
            }
        });
        
        // Function to start the game
        function startGame() {
            // Hide the start button container
            document.getElementById('startGameContainer').style.display = 'none';
            
            // Show the game canvas
            document.getElementById('gameCanvas').style.display = 'block';
            
            // Initialize the game
            if (typeof window.initializeGameWithAudio === 'function') {
                window.initializeGameWithAudio();
            }
        }

        // Game Controls toggle functionality
        // This is intentionally left empty - the toggleControls functionality
        // is now fully implemented in snowglider.js's initializeControlsToggle function

        // Enhance the start button with better mobile support
        const startGameButton = document.getElementById('startGameButton');
        if (startGameButton) {
            // Add touchstart/touchend events for more responsive mobile interaction
            startGameButton.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Prevent default touch behavior
                this.classList.add('touch-active'); // Add visual feedback class
            }, { passive: false });
            
            startGameButton.addEventListener('touchend', async function(e) {
                e.preventDefault(); // Prevent default touch behavior
                this.classList.remove('touch-active');
                
                // IMPORTANT: Do audio unlock HERE in the touch event
                console.log("Touch end - attempting audio unlock");
                
                if (window.AudioModule) {
                  try {
                    // Resume audio context in THIS touch gesture
                    await window.AudioModule.resumeAudioContext();
                    console.log("AudioContext resumed in touch handler");
                    
                    // Play pre-loaded audio immediately (still in touch gesture context)
                    window.AudioModule.playPreloadedAudio();
                  } catch (e) {
                    console.warn("Audio unlock in touch failed:", e);
                  }
                }
                
                // Start the game
                startGame();
            }, { passive: false });
            
            startGameButton.addEventListener('touchcancel', function(e) {
                this.classList.remove('touch-active');
            }, { passive: true });
        }
    });
  </script>
</body>
</html>